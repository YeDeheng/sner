B-API	0	9	Messenger
O	10	12	to
O	13	19	Remote
O	20	27	Service
O	28	35	Causing
O	36	42	Memory
O	43	47	Leak

O	48	49	I
O	50	54	have
O	55	57	an
O	58	69	application
O	70	74	that
O	75	87	communicates
O	88	92	with
O	93	94	a
O	95	102	Service
O	103	105	in
O	106	107	a
O	108	114	remote
O	115	122	process
O	123	128	using
O	129	132	the
B-API	133	142	Messenger
O	143	152	interface
O	152	153	.

O	154	158	Here
O	159	161	is
O	162	165	the
O	166	171	basic
O	172	184	architecture
O	185	187	of
O	188	191	how
O	192	198	things
O	199	202	are
O	203	206	set
O	207	209	up
O	210	211	:

O	212	215	The
O	216	227	application
O	228	237	generates
O	238	245	several
O	246	247	"
O	247	256	Operation
O	256	257	"
O	258	265	objects
O	266	270	that
O	271	278	require
O	279	285	access
O	286	288	to
O	289	292	the
O	293	300	service
O	300	301	.

O	302	306	Each
O	307	308	"
O	308	317	Operation
O	317	318	"
O	319	327	contains
O	328	329	a
O	330	337	Handler
O	338	345	wrapped
O	346	348	in
O	349	350	a
B-API	351	360	Messenger
O	361	365	used
O	366	368	to
O	369	376	receive
O	377	380	the
O	381	389	response
O	390	394	data
O	395	399	back
O	400	404	from
O	405	408	the
O	409	416	Service
O	417	421	When
O	422	425	the
O	426	435	operation
O	436	444	executes
O	444	445	,
O	446	448	it
O	449	454	wraps
O	455	458	its
B-API	459	468	Messenger
O	469	473	into
O	474	476	an
O	477	483	Intent
O	484	487	and
O	488	493	calls
B-API	494	508	startService()
O	509	511	to
O	512	516	pass
O	517	520	the
O	521	528	message
O	529	531	to
O	532	535	the
O	536	542	remote
O	543	550	service
O	551	554	The
O	555	561	remote
O	562	569	service
O	570	574	does
O	575	579	some
O	580	584	work
O	585	590	based
O	591	593	on
O	594	597	the
O	598	608	parameters
O	609	611	of
O	612	615	the
B-API	616	622	Intent
O	623	626	and
O	627	631	then
O	632	639	returns
O	640	643	the
O	644	652	response
O	653	655	by
O	656	663	sending
O	664	665	a
O	666	673	Message
O	674	676	to
O	677	680	the
B-API	681	690	Messenger
O	691	694	for
O	695	699	that
O	700	709	operation
O	709	710	.

O	711	715	Here
O	716	718	is
O	719	722	the
O	723	728	basic
O	729	733	code
O	734	741	present
O	742	744	in
O	745	748	the
O	749	758	operation
O	759	760	:
O	761	780	@codeSnippetRemoved

O	781	784	And
O	785	786	a
O	787	794	snippet
O	795	797	of
O	798	801	how
O	802	805	the
O	806	813	Service
O	814	816	is
O	817	827	structured
O	828	829	(
O	829	831	it
O	832	833	'
O	834	835	s
O	836	845	basically
O	846	848	an
B-API	849	862	IntentService
O	863	867	that
O	868	875	doesn't
O	876	880	shut
O	881	885	down
O	886	890	when
O	891	894	the
O	895	900	queue
O	901	903	is
O	904	909	empty
O	910	912	):
O	913	932	@codeSnippetRemoved

O	933	937	This
O	938	941	all
O	942	947	works
O	948	961	fantastically
O	962	966	well
O	966	967	.

O	968	969	I
O	970	973	can
O	974	978	send
O	979	983	tons
O	984	986	of
O	987	997	operations
O	998	1002	from
O	1003	1010	several
O	1011	1020	different
O	1021	1033	applications
O	1034	1036	to
O	1037	1040	the
O	1041	1045	same
O	1046	1053	service
O	1054	1057	and
O	1058	1062	they
O	1063	1066	all
O	1067	1074	process
O	1075	1078	and
O	1079	1083	send
O	1084	1089	their
O	1090	1098	response
O	1099	1101	to
O	1102	1106	just
O	1107	1110	the
O	1111	1116	right
O	1117	1122	place
O	1122	1123	.

O	1124	1131	However
O	1132	1135	...

O	1136	1137	I
O	1138	1145	noticed
O	1146	1150	that
O	1151	1153	if
O	1154	1157	the
O	1158	1169	application
O	1170	1173	ran
O	1174	1178	long
O	1179	1185	enough
O	1186	1189	and
O	1190	1194	with
O	1195	1201	enough
O	1202	1210	activity
O	1211	1213	it
O	1214	1219	would
O	1220	1225	crash
O	1226	1230	with
O	1231	1233	an
B-API	1234	1250	OutOfMemoryError
O	1250	1251	.

O	1252	1256	Upon
O	1257	1264	looking
O	1265	1267	at
O	1268	1271	the
B-Fram	1272	1277	HPROF
O	1278	1282	data
O	1283	1285	in
B-Fram	1286	1289	MAT
O	1289	1290	,
O	1291	1292	I
O	1293	1300	noticed
O	1301	1305	that
O	1306	1309	all
O	1310	1315	these
O	1316	1326	operations
O	1327	1332	where
O	1333	1340	staying
O	1341	1343	in
O	1344	1350	memory
O	1350	1351	,
O	1352	1355	and
O	1356	1360	they
O	1361	1365	were
O	1366	1370	held
O	1371	1378	hostage
O	1379	1383	from
O	1384	1387	the
O	1388	1395	Garbage
O	1396	1405	Collector
O	1406	1413	because
O	1414	1416	of
O	1417	1420	the
B-API	1421	1430	Messenger
O	1430	1431	.

O	1432	1442	Apparently
O	1442	1443	,
O	1444	1447	the
B-API	1448	1457	Messenger
O	1458	1466	instance
O	1467	1469	is
O	1470	1478	creating
O	1479	1480	a
O	1481	1490	long-term
O	1491	1497	native
O	1498	1508	connection
O	1509	1511	to
B-API	1512	1518	Binder
O	1519	1523	that
O	1524	1530	counts
O	1531	1533	as
O	1534	1535	a
O	1536	1538	GC
O	1539	1543	Root
O	1543	1544	,
O	1545	1550	which
O	1551	1553	is
O	1554	1561	keeping
O	1562	1566	each
O	1567	1568	"
O	1568	1577	Operation
O	1577	1578	"
O	1579	1585	object
O	1586	1588	in
O	1589	1595	memory
O	1596	1608	indefinitely
O	1608	1609	.

O	1610	1614	Does
O	1615	1621	anyone
O	1622	1626	know
O	1627	1629	if
O	1630	1635	there
O	1636	1638	is
O	1639	1640	a
O	1641	1644	way
O	1645	1647	to
O	1648	1653	clear
O	1654	1656	or
O	1657	1664	disable
O	1665	1668	the
B-API	1669	1678	Messenger
O	1679	1683	when
O	1684	1687	the
O	1688	1689	"
O	1689	1698	Operation
O	1698	1699	"
O	1700	1702	is
O	1703	1707	over
O	1708	1710	so
O	1711	1713	it
O	1714	1721	doesn't
O	1722	1728	create
O	1729	1733	this
O	1734	1740	memory
O	1741	1745	leak
O	1745	1746	?

O	1747	1749	Is
O	1750	1755	there
O	1756	1763	perhaps
O	1764	1771	another
O	1772	1775	way
O	1776	1778	to
O	1779	1788	implement
O	1789	1792	the
B-Stan	1793	1796	IPC
O	1797	1799	to
O	1800	1803	the
O	1804	1811	Service
O	1812	1814	in
O	1815	1818	the
O	1819	1823	same
O	1824	1831	fashion
O	1831	1832	,
O	1833	1835	so
O	1836	1840	that
O	1841	1849	multiple
O	1850	1859	disparate
O	1860	1867	objects
O	1868	1871	can
O	1872	1876	make
O	1877	1878	a
O	1879	1886	request
O	1887	1890	and
O	1891	1894	get
O	1895	1896	a
O	1897	1903	result
O	1904	1918	asynchronously
O	1918	1919	?

O	1920	1926	Thanks
O	1927	1929	in
O	1930	1937	advance
O	1937	1938	!

O	1939	1940	I
O	1941	1943	am
O	1944	1947	not
O	1948	1952	sure
O	1953	1955	if
O	1956	1960	this
O	1961	1963	is
O	1964	1967	the
O	1968	1972	best
O	1973	1976	way
O	1977	1982	since
O	1982	1983	,
O	1984	1988	even
O	1989	1991	if
O	1992	2000	Activity
O	2001	2003	is
O	2004	2006	in
O	2007	2010	the
O	2011	2021	background
O	2022	2025	you
O	2026	2030	will
O	2031	2034	get
O	2035	2038	the
O	2039	2046	message
O	2047	2051	from
O	2052	2059	Service
O	2059	2060	.

O	2061	2062	I
O	2063	2068	think
O	2069	2072	you
O	2073	2079	should
O	2080	2084	bind
O	2085	2087	to
O	2088	2091	the
O	2092	2099	service
O	2100	2103	and
O	2104	2112	register
O	2113	2114	a
B-API	2115	2124	messenger
O	2125	2127	to
O	2128	2131	the
O	2132	2139	service
O	2140	2142	as
O	2143	2147	soon
O	2148	2150	as
O	2151	2158	Service
O	2159	2161	is
O	2162	2171	connected
O	2171	2172	.

O	2173	2176	And
O	2177	2181	then
O	2182	2192	unregister
O	2193	2196	the
B-API	2197	2206	messenger
O	2207	2211	when
O	2212	2215	you
O	2216	2226	disconnect
O	2226	2227	.

O	2228	2233	Check
B-API	2234	2253	ExportVcardActivity
O	2254	2256	in
B-Fram	2257	2261	AOSP
O	2261	2262	.

O	2263	2265	It
O	2266	2268	is
O	2269	2278	following
O	2279	2288	something
O	2289	2294	along
O	2295	2300	these
O	2301	2306	lines
O	2306	2307	.

O	2308	2313	Looks
O	2314	2318	like
O	2319	2322	you
O	2323	2331	starting
O	2332	2333	a
O	2334	2337	lot
O	2338	2340	of
O	2341	2349	services
O	2350	2357	instead
O	2358	2360	of
O	2361	2368	binding
O	2369	2371	to
O	2372	2381	currently
O	2382	2389	running
O	2389	2390	.

O	2391	2393	It
O	2394	2396	is
O	2397	2406	difficult
O	2407	2409	to
O	2410	2415	judge
O	2416	2420	from
O	2421	2425	your
O	2426	2432	quotes
O	2432	2433	,
O	2434	2437	but
O	2438	2439	I
O	2440	2443	can
O	2444	2451	suppose
O	2452	2454	it
O	2455	2459	from
B-API	2460	2480	context.startService
O	2481	2482	(
O	2482	2495	serviceIntent
O	2496	2498	);
O	2499	2503	That
O	2504	2509	could
O	2510	2512	be
O	2513	2516	the
O	2517	2523	reason
O	2524	2526	of
O	2527	2533	memory
O	2534	2543	leak.IMHO
O	2544	2547	you
O	2548	2554	should
O	2555	2559	read
O	2560	2569	carefully
O	2570	2575	Bound
O	2576	2584	Services
O	2585	2587	to
O	2588	2593	check
O	2594	2597	you
O	2598	2602	code
O	2602	2603	.

O	2604	2610	Thanks
O	2611	2613	to
O	2614	2618	some
O	2619	2623	very
O	2624	2631	helpful
O	2632	2639	insight
O	2640	2644	from
O	2645	2651	Dianne
O	2652	2660	Hackborn
O	2661	2663	on
O	2664	2667	the
B-Plat	2668	2675	Android
O	2676	2680	team
O	2680	2681	,
O	2682	2685	the
O	2686	2691	issue
O	2692	2694	is
O	2695	2702	because
O	2703	2706	the
O	2707	2713	remote
O	2714	2721	service
O	2722	2729	process
O	2730	2733	has
O	2734	2737	not
O	2738	2741	yet
O	2742	2749	Garbage
O	2750	2759	Collected
O	2760	2762	it
O	2763	2764	'
O	2765	2766	s
O	2767	2775	instance
O	2776	2778	of
O	2779	2782	the
B-API	2783	2792	Messenger
O	2793	2798	which
O	2798	2799	,
O	2800	2802	in
O	2803	2809	effect
O	2809	2810	,
O	2811	2815	held
O	2816	2819	the
O	2820	2829	instances
O	2830	2832	in
O	2833	2836	the
O	2837	2848	application
O	2849	2850	'
O	2851	2852	s
O	2853	2860	process
O	2861	2868	hostage
O	2869	2874	until
O	2875	2879	that
O	2880	2884	time
O	2884	2885	.

O	2886	2890	This
O	2891	2893	is
O	2894	2897	the
O	2898	2902	text
O	2903	2905	of
O	2906	2909	her
O	2910	2915	reply
O	2916	2917	:

O	2918	2920	It
O	2921	2923	is
O	2924	2928	true
O	2929	2933	that
O	2934	2941	sending
O	2942	2943	a
B-API	2944	2953	messenger
O	2954	2960	across
O	2961	2970	processes
O	2971	2975	will
O	2976	2983	require
O	2984	2991	holding
O	2992	2993	a
O	2994	2998	GREF
O	2999	3001	on
O	3002	3004	it
O	3005	3008	for
O	3009	3012	the
O	3013	3018	other
O	3019	3026	process
O	3027	3029	to
O	3030	3041	communicate
O	3042	3046	with
O	3047	3049	it
O	3049	3050	.

O	3051	3058	Barring
O	3059	3063	bugs
O	3064	3065	(
O	3065	3070	which
O	3071	3075	have
O	3076	3084	happened
O	3085	3088	but
O	3089	3090	I
O	3091	3093	am
O	3094	3097	not
O	3098	3102	sure
O	3103	3105	if
O	3106	3108	in
O	3109	3112	any
O	3113	3121	released
O	3122	3130	platform
O	3131	3139	versions
O	3139	3140	)
O	3140	3141	,
O	3142	3145	the
O	3146	3150	GREF
O	3151	3155	will
O	3156	3158	be
O	3159	3167	released
O	3168	3172	when
O	3173	3176	the
O	3177	3182	other
O	3183	3190	process
O	3191	3197	itself
O	3198	3200	no
O	3201	3207	longer
O	3208	3213	holds
O	3214	3215	a
O	3216	3225	reference
O	3226	3228	on
O	3229	3233	this
O	3233	3234	.

O	3235	3239	When
O	3240	3242	we
O	3243	3246	are
O	3247	3254	talking
O	3255	3260	about
O	3261	3267	things
O	3268	3270	in
O	3271	3277	Dalvik
O	3278	3279	"
O	3279	3281	no
O	3282	3288	longer
O	3289	3294	holds
O	3295	3296	a
O	3297	3306	reference
O	3306	3307	"
O	3308	3317	generally
O	3318	3323	means
O	3324	3325	"
O	3325	3328	the
O	3329	3334	other
O	3335	3339	side
O	3340	3343	has
O	3344	3351	garbage
O	3352	3361	collected
O	3362	3365	the
B-API	3366	3370	Java
I-API	3371	3376	proxy
O	3377	3383	object
O	3383	3384	.

O	3385	3386	"
O	3386	3390	What
O	3391	3395	this
O	3396	3401	means
O	3402	3404	is
O	3405	3409	that
O	3410	3414	when
O	3415	3418	you
O	3419	3424	throw
O	3425	3426	a
B-API	3427	3436	Messenger
O	3437	3438	(
O	3438	3440	or
O	3441	3444	any
B-API	3445	3452	IBinder
O	3453	3459	object
O	3459	3460	)
O	3461	3467	across
O	3468	3470	to
O	3471	3478	another
O	3479	3486	process
O	3486	3487	,
O	3488	3491	the
O	3492	3498	Dalvik
O	3499	3501	VM
O	3502	3504	in
O	3505	3509	your
O	3510	3513	own
O	3514	3521	process
O	3522	3525	can
O	3526	3528	no
O	3529	3535	longer
O	3536	3542	manage
O	3543	3546	the
O	3547	3553	memory
O	3554	3556	of
O	3557	3561	that
O	3562	3568	object
O	3569	3575	itself
O	3576	3579	and
O	3580	3582	is
O	3583	3592	dependent
O	3593	3595	on
O	3596	3599	all
O	3600	3606	remote
O	3607	3614	objects
O	3615	3624	releasing
O	3625	3627	it
O	3628	3633	until
O	3634	3636	it
O	3637	3640	can
O	3641	3643	be
O	3644	3652	released
O	3653	3660	locally
O	3660	3661	.

O	3662	3665	And
O	3666	3670	this
O	3671	3675	will
O	3676	3683	include
O	3684	3687	all
O	3688	3695	objects
O	3696	3700	that
O	3701	3704	the
B-API	3705	3712	IBinder
O	3713	3716	has
O	3717	3720	any
O	3721	3731	references
O	3732	3734	to
O	3735	3737	as
O	3738	3742	well
O	3742	3743	.

O	3744	3745	A
O	3746	3752	common
O	3753	3760	pattern
O	3761	3763	to
O	3764	3768	deal
O	3769	3773	with
O	3774	3778	this
O	3779	3781	is
O	3782	3784	to
O	3785	3788	use
O	3789	3790	a
B-API	3791	3804	WeakReference
O	3805	3807	in
O	3808	3812	your
B-API	3813	3820	IBinder
O	3821	3822	/
B-API	3823	3832	Messenger
O	3833	3837	that
O	3838	3843	holds
O	3844	3847	the
O	3848	3858	references
O	3859	3861	to
O	3862	3865	the
O	3866	3870	rest
O	3871	3873	of
O	3874	3878	your
O	3879	3886	objects
O	3887	3891	that
O	3892	3894	it
O	3895	3899	will
O	3900	3906	access
O	3906	3907	.

O	3908	3912	This
O	3913	3919	allows
O	3920	3924	your
O	3925	3930	local
O	3931	3938	garbage
O	3939	3948	collector
O	3949	3951	to
O	3952	3957	clean
O	3958	3960	up
O	3961	3964	all
O	3965	3967	of
O	3968	3973	those
O	3974	3979	other
O	3980	3987	objects
O	3988	3989	(
O	3989	3994	which
O	3995	3998	may
O	3999	4001	be
O	4002	4007	quite
O	4008	4013	heavy
O	4013	4014	,
O	4015	4022	holding
O	4023	4026	big
O	4027	4033	things
O	4034	4038	like
O	4039	4046	bitmaps
O	4047	4050	and
O	4051	4055	such
O	4055	4056	)
O	4057	4061	even
O	4062	4068	though
O	4069	4070	a
O	4071	4077	remote
O	4078	4085	process
O	4086	4091	still
O	4092	4095	has
O	4096	4097	a
O	4098	4107	reference
O	4108	4110	on
O	4111	4115	your
B-API	4116	4123	IBinder
O	4123	4124	.

O	4125	4127	Of
O	4128	4134	course
O	4135	4137	if
O	4138	4141	you
O	4142	4144	do
O	4145	4149	this
O	4149	4150	,
O	4151	4156	there
O	4157	4162	needs
O	4163	4165	to
O	4166	4168	be
O	4169	4178	something
O	4179	4183	else
O	4184	4191	holding
O	4192	4193	a
O	4194	4203	reference
O	4204	4206	on
O	4207	4212	these
O	4213	4218	other
O	4219	4226	objects
O	4227	4232	until
O	4233	4237	they
O	4238	4241	are
O	4242	4244	no
O	4245	4251	longer
O	4252	4258	needed
O	4258	4259	,
O	4260	4262	or
O	4263	4267	else
O	4268	4271	the
O	4272	4279	garbage
O	4280	4289	collector
O	4290	4295	could
O	4296	4301	clean
O	4302	4306	them
O	4307	4309	up
O	4310	4316	before
O	4317	4321	they
O	4322	4325	are
O	4326	4328	no
O	4329	4335	longer
O	4336	4342	needed
O	4342	4343	.

O	4344	4353	Something
O	4354	4358	else
O	4359	4360	I
O	4361	4366	would
O	4367	4376	recommend
O	4377	4379	is
O	4380	4382	to
O	4383	4386	not
O	4387	4389	do
O	4390	4391	a
O	4392	4398	design
O	4399	4404	where
O	4405	4408	you
O	4409	4420	instantiate
B-API	4421	4430	Messenger
O	4431	4438	objects
O	4439	4442	for
O	4443	4447	each
B-Stan	4448	4451	IPC
O	4452	4455	you
O	4456	4458	do
O	4458	4459	.

O	4460	4466	Create
O	4467	4470	one
B-API	4471	4480	Messenger
O	4481	4485	that
O	4486	4489	you
O	4490	4494	pass
O	4495	4497	in
O	4498	4500	to
O	4501	4505	each
B-Stan	4506	4509	IPC
O	4510	4514	call
O	4514	4515	.

O	4516	4525	Otherwise
O	4526	4529	you
O	4530	4533	can
O	4534	4542	generate
O	4543	4544	a
O	4545	4548	lot
O	4549	4551	of
O	4552	4559	remoted
O	4560	4567	objects
O	4568	4572	that
O	4573	4576	are
O	4577	4582	being
O	4583	4587	kept
O	4588	4594	around
O	4595	4598	due
O	4599	4601	to
O	4602	4607	other
O	4608	4617	processes
O	4618	4628	continuing
O	4629	4631	to
O	4632	4636	hold
O	4637	4647	references
O	4648	4655	because
O	4656	4659	the
O	4660	4665	other
O	4666	4670	side
O	4671	4673	is
O	4674	4677	not
O	4678	4690	aggressively
O	4691	4698	garbage
O	4699	4709	collecting
O	4710	4715	since
O	4716	4719	all
O	4720	4723	the
O	4724	4731	objects
O	4732	4734	it
O	4735	4737	is
O	4738	4746	creating
O	4747	4750	due
O	4751	4753	to
O	4754	4759	these
O	4760	4765	calls
O	4766	4769	are
O	4770	4775	small
O	4775	4776	.

O	4777	4781	More
O	4782	4786	Info
O	4787	4788	:
O	4789	4864	https://groups.google.com/d/msg/android-developers/aK2o1W2xrMU/Z0-QujnU3wUJ
